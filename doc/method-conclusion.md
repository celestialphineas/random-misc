## 单细胞数据处理

### 复原基因组（Recovering Genomes）

从单细胞测序数据中发现并复原基因组会面临如下挑战：

* 每个细胞测序数据中的信息并不足以覆盖其物种的整个基因组。因此，将来自同一个物种的不同细胞的测序数据信息结合起来就很有必要。最常见的做法是协同组装（co-assembly）。
* 极其大量的细胞会给一些操作带来问题，例如协同组装和聚类，其空间复杂度往往要高于$O(N)$，这会消耗巨大的内存资源，从而难以计算。
* 生化实验方法会在数据中引入人工效应，包括测序深度的选择性偏斜（bias）、污染（contamination）和噪声。{{Shapiro 2013}}

为了让计算更加有效率，我们提出了一种新的单细胞数据分析流程，以尽可能多地复原基因组。其大致的想法是，首先按照细胞的分类单元分组，在每组中按照序列之间的相似度去聚类相似的测序数据，协同组装得到更优质的DNA序列，继续序列比较与聚类并协同组装，最终明确细胞之间的物种界限，协同组装得到基因组。

{{复原基因组流程图}}

### 利用Kaiju对细胞分类

我们希望比较所有细胞之间的相似度，把足够相似的细胞聚合在一起。但这样做涉及到计算细胞之间两两的相似度并聚类，而这项工作不可避免地需要在时间或空间上利用$\Omega(N^2)$的资源。对于可供我们使用的最多240 GB的内存而言，在使用常用工具集的情况下，只能比较不超过7000组序列间的两两相似度。这也是我们做预分类的动机，先将特征差异较大，尽可能容易分离的数据分离，然后再利用精细程度更高的方法去聚类与分类。

Kaiju基于查找，可以为测序数据中的每个读分配一个分类单元，而分类级别（rank）可能是域界门纲目科属种中的任意一级，或是这些标准分类级别之间的某组（group）。尽管Kaiju的输出结果十分精细，部分分类单元可以达到属甚至是种一级，但由于实验、测序和工具本身的局限，其分类结果并不能十分精确地确定细胞的分类单元。其主要问题有：

* 会有一部分无法被分类到任何级别的读，这部分读在我们的数据中占比达到16%
* 随着分类级别越来越细，有这一级别分类单元的读也会越来越少
* 已知、未知和没有分类的比例在不同细胞中是不均匀的
* 每个细胞测序数据中的读所属的分类单元组成会十分复杂，其原因也是多样的，包括分类工具本身的缺陷，以及实验手段引入的噪声和污染

{{左图：所有读在不同分类级别下的百分比}}

{{右图：在目的分类级别下占比最多的分类单元（包括未知但不包括无分类）在细胞中的占比，细胞频数分布直方图}}

为了尽可能多也尽可能可信地利用分类信息，我们在目这一级别下将细胞分类。这些细胞共属于18个已知的目，也有部分细胞在目一级没有较好的分类单元。

| 编号 | 目                 | 细胞数目 |
| ---- | ------------------ | -------- |
| 1    | Clostridiales      | 14583    |
| 2    | Bacteroidales      | 3490     |
| 3    | Unclassified       | 2836     |
| 4    | Acidaminococcales  | 316      |
| 5    | Coriobacteriales   | 290      |
| 6    | Burkholderiales    | 88       |
| 7    | Eggerthellales     | 76       |
| 8    | Lactobacillales    | 60       |
| 9    | Fusobacteriales    | 56       |
| 10   | Bifidobacteriales  | 51       |
| 11   | Desulfovibrionales | 35       |
| 12   | Erysipelotrichales | 18       |
| 13   | Verrucomicrobiales | 8        |
| 14   | Pasteurellales     | 2        |
| 15   | Veillonellales     | 1        |
| 16   | Streptomycetales   | 1        |
| 17   | Selenomonadales    | 1        |
| 18   | Corynebacteriales  | 1        |
| 19   | Bacillales         | 1        |

在目一级分类的情况下，大多数组的细胞数已经降低到容易计算的水平。但Clostridiales（梭菌目）所对应的细胞数目仍然很多。Clostridiales是人类肠道中十分常见的一类微生物。为了应对这一问题，我们尝试将Clostridiales向科一级分类：

| 编号 | 科                                        | 细胞数目 |
| ---- | ----------------------------------------- | -------- |
| 1-1  | Unclassified                              | 6639     |
| 1-2  | Ruminococcaceae                           | 3589     |
| 1-3  | Lachnospiraceae                           | 3346     |
| 1-4  | Eubacteriaceae                            | 623      |
| 1-5  | Clostridiaceae                            | 324      |
| 1-6  | Oscillospiraceae                          | 38       |
| 1-7  | Bacteroidaceae                            | 14       |
| 1-8  | Coriobacteriaceae                         | 5        |
| 1-9  | Peptostreptococcaceae                     | 1        |
| 1-10 | Fusobacteriaceae                          | 1        |
| 1-11 | Eggerthellaceae                           | 1        |
| 1-12 | Desulfovibrionaceae                       | 1        |
| 1-13 | Clostridiales Family XIII. Incertae Sedis | 1        |

至此，我们将细胞分为31组，每组的细胞数都能够允许我们做序列比较，使得下一步分析成为可能。

### 细胞聚类

对以上每一组细胞，我们都利用Sourmash计算其中细胞两两的序列相似度。考虑到每个细胞测序数据的读长，我们选取$k=21,s=500$，即*k*-mer长度为21，选取500个序列计算MinHash（相当于每个细胞测序数据提取维度为500的向量）。较小的$k$有助于提升算法的敏感程度。{{Ondov 2015}}

在Sourmash计算出距离矩阵之后，利用scikit-learn分层聚类，并分割树状图，使得每个簇内部的最大距离不超过阈值$D$。

{{目前这个阈值的选取很随意}}

如此，上述31组中细胞数大于2的组都将会被细分。我们期望于相同物种的细胞被分在同一组，因此$D$取值应该相对较小，以保证较高的准确率。但在这一阶段，召回率并不重要，因为我们对每个细胞所拥有的信息太少，所有相同物种的细胞在这一层次都有较高的相似度。

在对相似的细胞协同组装后，我们可以拥有比原始测序数据更长的DNA序列。更多细胞综合起来的信息也相较单独细胞的测序原始数据更多，原有的由于技术局限引入的测序位置相对于整个基因组的偏斜也得以消除。这些都有助于我们接下来更好地对细胞聚类。

{{目前的工作尚无法定量地支持co-assembly对提升序列相似度比较准确性有帮助}}

在获得组装结果之后，我们再次依分类单元，对组装结果做序列相似度比较。随后将相似序列所对应的细胞聚合成新的细胞类，再次协同组装。如此迭代，直至我们观察到较多数目的组装序列大小接近于细菌的基因组大小。

